# background 项目

## 字体的加载，控制最大并发数

需求：

有 100 个字体存储在 s3 上需要在某个页面被加载但：

1. 不能同时发送 100 个请求，建立 100 个 http 连接，因为这样可能阻塞网络，并且导致大家一起加载缓慢
   不能一个接一个串行请求，因为效率低下
   需要接受一个参数，尽可能高并发的前提下控制最大并发数
2. 用户主动选择某一个字体时，让这个字体优先被加载
3. 需要能够控制什么时候开始自动加载，什么时候停止加载，什么时候继续自动加载
   这样就能在某些时刻，比如组件展示时开始自动加载全部字体，组件卸载或页面切换时停止加载这些字体

方案：

1. 使用 FontFace 构造器加载字体资源，而不是通过 css 代码或 script 标签
2. 使用 mergeMap 控制最大并发数
3. 把加载单一字体的 API 暴露出来，它不受并发数限制
4. 暴露一个有 start 和 stop 函数成员的对象，把源 Observable 改造成`defer(() => from(unloadedFontList))`的形式，并维护一个未加载字体列表，start 时开启订阅，end 时关闭订阅，同时为了避免重复开启和关闭流，用检查定时器的方式检查和维护 subscription

## 一连串异步+同步任务的终止

需求：

某些任务由许多异步和产生副作用的同步任务组成，需要中断这个流程的执行，并阻止后续副作用的发生

方案：

1. 用 switchMap 串联异步，用 tap 串联同步，用 map 做简单的数据加工，组成一个大的 observable
2. 建立一个 Subject，用 takeUntil 接受它，并在外部调用这个 Subject 的 next 来发送提示结束推流
3. 用 finalize 和 tap 打扫场地，需要重新调用时候重新 subscribe 这个大 observable 就可以了
