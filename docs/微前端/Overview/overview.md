# Overview

## 常见应用场景

国内大厂 B 端应用比较多

1. 组合不同前端技术栈构成页面
2. 页面性能不敏感的场景
3. 管理后台类场景
4. web 商店, 提供微前端的入驻, 有点类似微信小程序
5. 旧项目渐进式迁移 (无界)

C 端用微前端框架几乎是没有的, 基本都是管理后台, 完全不好优化, 加载时长完全不可控

B 端对页面性能不敏感, 国内大厂内部应用比较多

国内的管理的后台可以做得非常大, 左边的菜单就能做五六十个, 会一直在加功能进去
相反, 国外的管理后台很少做到这么大的, 一般情况不会在一个管理后台把所有的事情完完全全地做完
这种场景下, 如果是三到四个技术团队在一起堆页面, 一定是很痛苦的

所以是有要分开业务的需求,
技术架构到最后一定是组织架构, 组织架构, 其实就决定了业务架构, 当然也不一定需要微前端

国外对微前端几乎没有讨论, 大部分更关系 ssr, 缩小页面体积, react server components 等等,
用了微前端后, 首先在视觉风格上高概率都不是统一的, 用的组件多半也不是统一的, 交互也多半不是统一的, 国内对缝合怪的容忍度更高一些

## 常见方案

微前端框架 本质上就是要解决 应用隔离
因此要解决 JS 隔离 样式隔离 路由同步 应用通信这些

JS 隔离:
实际上很多方案的沙箱都是可以突破的
tc39 有一个提案是 ShadowRealm API, 允许一个 JS 运行时创建多个高度隔离的, 真正完全封闭的, 不可突破的 JS 运行环境, 这也是中国区的代表中呼声很高的一个 api
可以基于这个 API 来实现更好的微前端方案
wujie 的做法是把 js 代码丢进 iframe 中去跑

CSS 隔离:
乾坤的样式隔离是比较费劲的, 子应用自己用 css module 或者 vue 的 scope 方式去隔离, 自己解决 (但这个不一定是缺点, 有的做平台的公司会更倾向于这个, 把 css 隔离的问题丢给入驻方)
webcomponents 方式隔离更好一些,
但也会有问题, 比如 shadow root 的事件的 target 判断, input 标签的拖拽丢下的判断, 字体的加载
字体不能放在 shadow dom 里加载, 字体可能会直接失败显示不出来, 标准就是这样, 导致一些隐式依赖字体图标的组件库可能会出问题, 可能需要手动去用 svg 的方式去替换字体图标

通信 wujie 是发布订阅的方式, 也可以通过闭包与函数调用去通信

这里面最复杂的还是 JS 沙箱的制作, 修修补补, 很多技术的组合在一起, 能跑起来, 还是很考验框架作者能力的

### iframe

优点:
接入比较简单
隔离非常完美

缺点:
dom 割裂感严重, 弹框只能在 iframe, 而且有滚动条
通讯非常麻烦, 而且刷新 iframe url 状态丢失
前进后退按钮无效

### qiankun

qiankun 是基于 single-spa 的微前端方案
用乾坤和无界 其实都是无所谓的 做平台的人其实都是不管的
所以更倾向于乾坤这样的方案 我是做平台的, 微前端好不好用 是你们入驻的人自己的问题 入驻的人想自己的方式去解决问题 比如 css 隔离等等

TODO: JS 沙箱 样式隔离

优点:
html entry 的方式引入子应用, 相比 js entry 降低了应用改造的成本
做了静态资源预加载能力
完备的沙箱方案

缺点:
适配成本非常高, 工程化、生命周期、静态资源路径、路由等都要做一系列的适配工作
css 隔离有问题
js 沙箱在某些场景下执行性能下降严重 proxy + with
无法同时激活多个子应用, 也不支持子应用保活
无法支持 vite 等 esmodule 脚本运行

### garfish

garfish 字节内部的应用很多 和 qiankun 区别不大 api 都差不多 说是高仿也没问题

### micro-app

micro-app 是基于 webcomponent + qiankun sandbox 的微前端方案

优点:
使用 webcomponet 加载子应用相比 single-spa 这种注册监听方案更加优雅
支持子应用保活
降低子应用改造的成本, 提供静态资源预加载能力

缺点:
css 样式隔离有问题
js 沙箱做全局变量查找缓存, 性能有所优化, 但仍会下降
支持 vite 运行, 但必须使用 plugin 改造子应用, 且 js 代码没办法做沙箱隔离
对于不支持 webcompnent 的浏览器没有做降级处理

### EMP 方案

基于 webpack 5 module federation 的微前端方案
模块联邦在国内几乎没有声音, 听一些人的技术分享,三年前在国内还是有一定声音的, 后来都换成了自己的模块方案
现在的用户基本就是, webpack 中优化打包, 但也用的不多, 这个东西现在真的是没啥用了, 稍微去搜两个应用基本上是搜不到
emp2.0 也从这种方案切走了

### wujie

把 js 丢进 iframe 里去执行, 把 dom 放进 webcomponent 中, 从而实现 js 和 css 隔离

优点:
接入简单只需要四五行代码
天然支持 vite
预加载
应用保活机制

缺点:
隔离 js 使用一个空的 iframe 进行隔离, 不够严格
子应用 axios 需要自行适配
iframe 沙箱的 src 设置了主应用的 host, 初始化 iframe 的时候需要等待 iframe 的 location.orign 从'about:blank'初始化为主应用的 host, 这个采用的计时器去等待的不是很优雅

## 为什么使用微前端

自己的角色 决策+执行
业务怎么落地
部署为了用微前端而用微前端
微前端其实是工程化能力的一部分体现: 开发工作流 运维部署

乾坤 无界 它本身不是方案
频繁地改-配置化 频繁地加-服务化
